# 직관 동행 방 로직 최종 정책 (MVP)

> 목적: “방 생성 → 신청(대기열) → 승인 즉시 참여(채팅 입장)” 흐름을 일관되게 유지하며,
> 운영 리스크(스팸/재신청/정원 꼬임/중복 참여)를 최소화한다.

---

## 1) 핵심 정책 요약

### 1-1. 참여자 상태(Enum) (신청~참여 단일 상태)

- `PENDING` : 승인 대기(대기열)
- `CANCELLED` : 신청 취소(대기 상태에서만)
- `REJECTED` : 거절됨 (해당 방 재신청 불가)
- `JOINED` : 승인됨 & 참여 중(승인 즉시 참여)
- `LEFT` : 스스로 나감
- `KICKED` : 강퇴됨 (해당 방 재신청 불가)

### 1-2. 신청 개수 제한

- **한 경기당 `PENDING` 최대 3개**까지 허용

### 1-3. FULL이어도 신청 가능(대기열 운영)

- 방이 `FULL`이어도 **신청 가능**(대기열 `PENDING`으로 쌓임)
- 사용자 UX는 “입장”이 아니라 **“대기 신청”**으로 표현

### 1-4. 재신청 정책(방 단위)

- 해당 방에서 `REJECTED` 또는 `KICKED` 이력이 있으면 **해당 방에는 끝까지 재신청 불가**
- 다른 방에는 제한 없이 신청/참여 가능

### 1-5. 중복 참여 방지(경기 기준)

- **한 경기에서 `JOINED`(참여 확정)는 1개 방만 가능**
- 중복 참여 방지는 **승인 시점(방장 액션)**에서 최종 방어한다.

---

## 2) 방 노출/모집 상태(Enum) (권장)

> 방 상태는 “노출/모집”을 위한 상태이며, 참여자 상태와 분리한다.

- `OPEN` : 모집 중(자리 있음 또는 FULL이어도 대기 신청 허용)
- `FULL` : 정원 도달(자리 없음, 대기 신청은 가능)
- `CLOSED` : 모집 종료(방장이 종료한 상태, 자리 생겨도 OPEN으로 자동 복귀 X)
- `DELETED` : 삭제/해산(접근 불가)

**자동 전환 규칙**

- `JOINED` 수가 정원 도달 → `OPEN → FULL`
- 누군가 `LEFT` 또는 `KICKED`로 빠져 자리 생김 → `FULL → OPEN` (단, `CLOSED`면 유지)

---

## 3) 신청 버튼 활성 조건(체크리스트)

사용자가 특정 방에 신청 가능 iff

- (경기 기준) 내 `PENDING` 개수 < 3
- 이 방에 대해 내 상태가 `REJECTED` 또는 `KICKED`가 아님
- 현재 이 방에서 `JOINED` 상태가 아님
- 방이 `DELETED`가 아님

> 방이 FULL이어도 신청은 가능(버튼 라벨: “대기 신청”)

---

## 4) 상태 전이표

| 주체 | 액션                | From → To               | 비고/조건                                                               |
| ---- | ------------------- | ----------------------- | ----------------------------------------------------------------------- |
| 유저 | 입장 신청/대기 신청 | (없음) → `PENDING`      | OPEN/FULL 모두 가능                                                     |
| 유저 | 신청 취소           | `PENDING` → `CANCELLED` | 대기 중만 가능                                                          |
| 방장 | 신청 승인           | `PENDING` → `JOINED`    | 승인 즉시 참여. **승인 시 정원 재확인 + 경기 내 중복 JOINED 여부 체크** |
| 방장 | 신청 거절           | `PENDING` → `REJECTED`  | 해당 방 재신청 불가                                                     |
| 유저 | 방 나가기           | `JOINED` → `LEFT`       | 자리 생기면 `FULL → OPEN` 자동                                          |
| 방장 | 강퇴                | `JOINED` → `KICKED`     | 해당 방 재신청 불가                                                     |

---

## 5) CLOSED / DELETED 처리 규칙

### 5-1. CLOSED(모집 종료)

- 신규 신청은 가능/불가 중 하나로 고정(권장: **불가**)
- 기존 `PENDING`은 “모집 종료됨” 안내(승인 처리 불가)
- 기존 `JOINED`는 채팅은 유지(정책에 따라 종료 시점 조정 가능)

### 5-2. DELETED(삭제/해산)

- 방 상세/채팅 접근 불가
- `JOINED`/`PENDING` 사용자에게 “방이 삭제되었습니다” 안내(알림/토스트 등)
- 목록에서는 제거(soft delete 권장)

---

## 6) UX 문구 가이드(권장)

- `OPEN` + 자리 있음: “입장 신청”
- `FULL`(자리 없음): “대기 신청” / “현재 정원이 찼어요. 대기열에 등록됩니다.”
- `PENDING`: “승인 대기 중” + “신청 취소” 버튼
- `REJECTED`/`KICKED`: “이 방에는 재신청할 수 없어요.”

---

## 7) 시나리오 예시

### 시나리오 1) 기본 흐름(신청→승인→참여→나감)

1. 유저 A 신청 → `PENDING`
2. 방장 승인 → `JOINED`(즉시 채팅 입장)
3. A 나가기 → `LEFT`
4. 방이 `FULL`이었다면 자리 생김 → 방 상태 `FULL → OPEN`

### 시나리오 2) FULL이어도 대기 신청

1. 방이 `FULL`
2. A “대기 신청” → `PENDING`
3. 자리 생김(`LEFT/KICKED`) → 방 상태 `OPEN`
4. 방장 A 승인 → `JOINED`

### 시나리오 3) 한 경기당 신청 3개 제한

1. A가 같은 경기에서 `PENDING` 3개 보유
2. 4번째 신청 시도 → 불가(“한 경기 최대 3개까지 대기 신청 가능”)

### 시나리오 4) 중복 참여 방지(Option B)

1. A가 방1, 방2 모두 `PENDING`
2. 방1에서 A 승인 → A는 방1 `JOINED`
3. 방2 방장이 A 승인 시도 → 실패(“이미 다른 방에 참여 중인 유저입니다.”)

### 시나리오 5) 거절/강퇴 후 해당 방 재신청 차단

1. A `REJECTED` 또는 `KICKED`
2. 같은 방 재신청 시도 → 불가(재신청 차단)

---

## 8) 구현 메모(권장)

- 방 생성 시 방장은 자동으로 `JOINED` 처리 + role=`HOST`로 구분(조회/권한 단순화)
- 승인 로직은 서버에서 원자적으로 처리(트랜잭션/조건부 업데이트)하여 정원 초과 방지
